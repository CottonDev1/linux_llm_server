<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Browser - EWR Knowledge Base</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/ewr-classes.css">
    <style>
        /* Dark Blue Theme - Always Dark (matching SQL chat) */
        :root {
            --bg-primary: #0c1929;
            --bg-secondary: #142338;
            --bg-tertiary: #1e3a5f;
            --bg-card: #142338;
            --bg-input: #142338;
            --text-primary: #e8f2ff;
            --text-secondary: #b8d4f0;
            --text-muted: #6b8cae;
            --border-primary: #1e3a5f;
            --border-secondary: #2d5a8a;
            --accent-primary: #5a9fe6;
            --accent-secondary: #7ab8f5;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --glow-accent: rgba(90, 159, 230, 0.3);
        }

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: var(--bg-primary);
            line-height: 1.6;
        }

        /* Single column layout */
        .documents-layout {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 150px);
            position: relative;
        }
    </style>
</head>
<body>
    <!-- Main Layout -->
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="app-sidebar">
            <div class="sidebar-brand">
                <div class="sidebar-logo">EWR</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-role" id="userRole">User</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <!-- Navigation generated by sidebar.js -->
            </nav>
        </aside>

        <!-- Main Content Area -->
        <div class="app-main">
            <!-- Header -->
            <header class="app-header">
                <div class="header-content">
                    <div class="header-left">
                        <div>
                            <h1 class="header-title">Document Browser</h1>
                        </div>
                    </div>
                    <div class="header-right">
                        <div class="header-status" id="systemStatus">
                            <div class="status-dot" id="statusDot"></div>
                            <span class="status-text" id="statusText">Connecting...</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <main class="app-content">
                <div class="content-wrapper">
                    <div class="documents-layout">
                        <!-- Full Width Card -->
                        <div class="card ewr_chat-card-full">
                            <!-- Collapsible Document Filters -->
                            <div class="ewr-collapsible no-margin" id="filterCollapsible">
                                <div class="ewr-collapsible-header" onclick="toggleCollapsible('filterCollapsible')">
                                    <span class="ewr-collapsible-title">Document Filters</span>
                                    <button class="ewr-collapse-toggle">
                                        <span class="toggle-icon">â–¼</span>
                                    </button>
                                </div>
                                <div class="ewr-collapsible-content">
                                    <div class="ewr-edit-filters-horizontal">
                                        <div class="ewr-edit-div-vert">
                                            <label class="ewr-label">Department</label>
                                            <select id="browserDepartmentFilter" class="ewr-select-edit">
                                                <option value="">All Departments</option>
                                            </select>
                                        </div>
                                        <div class="ewr-edit-div-vert">
                                            <label class="ewr-label">Doc Type</label>
                                            <select id="categoryFilter" class="ewr-select-edit">
                                                <option value="">All Types</option>
                                            </select>
                                        </div>
                                        <div class="ewr-edit-div-vert">
                                            <label class="ewr-label">Subject</label>
                                            <select id="browserSubjectFilter" class="ewr-select-edit">
                                                <option value="">All Subjects</option>
                                            </select>
                                        </div>
                                        <div class="ewr-edit-div-vert">
                                            <label class="ewr-label">Result Title Contains</label>
                                            <input type="text" id="searchFilter" class="ewr-input-edits" placeholder="Filter loaded results by title...">
                                        </div>
                                    </div>
                                </div>
                                <!-- Footer with Action Buttons -->
                                <div class="ewr-collapsible-footer">
                                    <button class="ewr-button-action-green-gradient" id="loadDocsBtn" onclick="loadDocuments()">Load Documents</button>
                                </div>
                            </div>

                            <!-- Document List Section -->
                            <ewr-document-list
                                id="documentList"
                                title="Matching Documents"
                                empty-message="Select filters and click &quot;Load Documents&quot; to see matching documents"
                                on-item-click="openDocumentPreview">
                            </ewr-document-list>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Document Preview Modal -->
    <div class="ewr-document-popup-overlay" id="documentPreviewModal">
        <div class="ewr-document-popup">
            <div class="ewr-document-popup-header">
                <h3 class="ewr-document-popup-title" id="documentPreviewTitle">Document Preview</h3>
                <button class="ewr-document-popup-close" onclick="closeDocumentPreview()">&times;</button>
            </div>
            <div class="ewr-document-popup-body">
                <div class="ewr-document-popup-meta" id="documentPreviewMeta">
                    <!-- Document metadata will be inserted here -->
                </div>
                <div class="ewr-document-popup-content" id="documentPreviewContent">
                    Loading document content...
                </div>
            </div>
            <div class="ewr-document-popup-footer">
                <div class="ewr-document-popup-footer-left">
                    <button class="ewr-button-action-green-gradient" id="copyDocBtn" onclick="copyDocumentContent()">Copy to Clipboard</button>
                    <button class="ewr-button-action-green-gradient" id="downloadDocBtn" onclick="downloadDocument()">Download</button>
                </div>
                <button class="ewr-button-clear" onclick="closeDocumentPreview()">Close</button>
            </div>
        </div>
    </div>

    <script src="../js/auth-client.js"></script>
    <script src="../js/ewr-components.js"></script>
    <script src="../js/sidebar.js"></script>
    <script src="../js/system-status.js"></script>
    <script>
        // Initialize auth client
        const auth = new AuthClient();

        // Store all loaded documents for client-side filtering (declare early to avoid TDZ)
        let allLoadedDocuments = [];
        let searchTimeout = null;

        // Check authentication and initialize after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            if (!auth.isAuthenticated()) {
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
            } else {
                if (typeof initSidebar === 'function') {
                    initSidebar();
                }
                updateUserInfo();
                loadCategories();

                // Set up search filter listener
                const searchInput = document.getElementById('searchFilter');
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(applySearchFilter, 300);
                    });
                }
            }
        });

        async function updateUserInfo() {
            try {
                const user = await auth.getUser();
                if (user) {
                    const userNameEl = document.getElementById('userName');
                    const userRoleEl = document.getElementById('userRole');
                    if (userNameEl) userNameEl.textContent = user.username;
                    if (userRoleEl) userRoleEl.textContent = user.role || 'User';
                }
            } catch (error) {
                console.error('Failed to get user info:', error);
            }
        }

        function logout() {
            auth.logout();
        }

        // Toggle collapsible container
        function toggleCollapsible(id) {
            const container = document.getElementById(id);
            if (container) {
                container.classList.toggle('collapsed');
            }
        }

        // ==================== CATEGORY MANAGEMENT ====================

        let categoryData = {
            departments: [],
            types: [],
            subjects: []
        };

        async function loadCategories() {
            try {
                const response = await fetch('/api/python/categories', {
                    headers: {
                        'Authorization': `Bearer ${auth.getAccessToken()}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    categoryData.departments = data.departments || [];
                    categoryData.types = data.types || [];
                    categoryData.subjects = data.subjects || [];
                    populateDropdowns();
                } else {
                    console.error('Failed to load categories:', response.statusText);
                    // Show error - dropdowns will remain empty
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                // Show error - dropdowns will remain empty
            }
        }

        function populateDropdowns() {
            const browserDept = document.getElementById('browserDepartmentFilter');
            const browserType = document.getElementById('categoryFilter');
            const browserSubject = document.getElementById('browserSubjectFilter');

            if (browserDept) {
                browserDept.innerHTML = '<option value="">All Departments</option>' +
                    categoryData.departments.map(d => `<option value="${d.id || d.name}">${d.name || d.id}</option>`).join('');
            }
            if (browserType) {
                browserType.innerHTML = '<option value="">All Types</option>' +
                    categoryData.types.map(t => `<option value="${t.id || t.name}">${t.name || t.id}</option>`).join('');
            }
            if (browserSubject) {
                browserSubject.innerHTML = '<option value="">All Subjects</option>' +
                    categoryData.subjects.map(s => `<option value="${s.id || s.name}">${s.name || s.id}</option>`).join('');
            }
        }

        // ==================== DOCUMENT BROWSER FUNCTIONALITY ====================

        async function loadDocuments() {
            const documentListComponent = document.getElementById('documentList');

            // Get filter elements
            const departmentSelect = document.getElementById('browserDepartmentFilter');
            const docTypeSelect = document.getElementById('categoryFilter');
            const subjectSelect = document.getElementById('browserSubjectFilter');

            // Get filter values
            const department = departmentSelect?.value || '';
            const docType = docTypeSelect?.value || '';
            const subject = subjectSelect?.value || '';
            const search = document.getElementById('searchFilter')?.value?.trim() || '';

            // Get display text for selected options (for filter tags)
            const departmentText = departmentSelect?.selectedOptions[0]?.text || '';
            const docTypeText = docTypeSelect?.selectedOptions[0]?.text || '';
            const subjectText = subjectSelect?.selectedOptions[0]?.text || '';

            // Show loading state using component API
            documentListComponent.showLoading();

            try {
                // Build query parameters
                const params = new URLSearchParams();
                if (department) params.append('department', department);
                if (docType) params.append('type', docType);
                if (subject) params.append('subject', subject);
                if (search) params.append('search', search);

                // Fetch filtered documents
                const response = await fetch(`http://localhost:8001/documents/aggregate?${params.toString()}`);
                const data = await response.json();

                if (data.success) {
                    // Use documents array (with metadata) if available, fall back to titles
                    const documents = data.documents || data.titles || [];
                    console.log('API Response - has documents array:', !!data.documents, 'Sample:', documents[0]);
                    allLoadedDocuments = documents;

                    // Update filter tags (only show if a specific value is selected, not "All...")
                    documentListComponent.setFilterTags({
                        department: department ? departmentText : '',
                        docType: docType ? docTypeText : '',
                        subject: subject ? subjectText : ''
                    });

                    if (documents.length === 0) {
                        documentListComponent.showEmpty('No documents found. Try adjusting your filter criteria.');
                    } else {
                        // Pass full document objects to display category tags
                        documentListComponent.setDocuments(documents);
                    }
                } else {
                    allLoadedDocuments = [];
                    documentListComponent.clearFilterTags();
                    documentListComponent.showError(data.error || 'Failed to load documents');
                }
            } catch (error) {
                allLoadedDocuments = [];
                documentListComponent.clearFilterTags();
                documentListComponent.showError(error.message);
            }
        }

        // Real-time search filtering
        function applySearchFilter() {
            const searchTerm = document.getElementById('searchFilter')?.value?.trim().toLowerCase() || '';
            const documentListComponent = document.getElementById('documentList');

            if (allLoadedDocuments.length === 0) {
                return; // No documents loaded yet
            }

            // Filter documents based on search term (supports both string and object formats)
            const filteredDocs = searchTerm
                ? allLoadedDocuments.filter(doc => {
                    const title = typeof doc === 'string' ? doc : (doc.title || '');
                    return title.toLowerCase().includes(searchTerm);
                })
                : allLoadedDocuments;

            // Update display using component API
            if (filteredDocs.length > 0) {
                documentListComponent.setDocuments(filteredDocs);
            } else {
                documentListComponent.showEmpty('No documents match your search criteria');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== DOCUMENT PREVIEW FUNCTIONALITY ====================

        let currentPreviewDocument = null;

        async function openDocumentPreview(title) {
            const modal = document.getElementById('documentPreviewModal');
            const titleEl = document.getElementById('documentPreviewTitle');
            const metaEl = document.getElementById('documentPreviewMeta');
            const contentEl = document.getElementById('documentPreviewContent');

            currentPreviewDocument = null;

            // Show modal (ewr-document-popup-overlay uses 'active' class)
            modal.classList.add('active');
            titleEl.textContent = title;
            metaEl.innerHTML = 'Loading metadata...';
            contentEl.textContent = 'Loading document content...';

            try {
                const response = await fetch(`http://localhost:8001/documents/by-title?title=${encodeURIComponent(title)}`);

                if (!response.ok) {
                    throw new Error(`Failed to fetch document: ${response.statusText}`);
                }

                const doc = await response.json();
                currentPreviewDocument = doc;

                metaEl.innerHTML = `
                    <div><strong>Department:</strong> ${doc.department || 'N/A'}</div>
                    <div><strong>Type:</strong> ${doc.type || 'N/A'}</div>
                    <div><strong>Subject:</strong> ${doc.subject || 'N/A'}</div>
                    <div><strong>Chunks:</strong> ${doc.total_chunks || 1}</div>
                    ${doc.file_size ? `<div><strong>Size:</strong> ${(doc.file_size / 1024).toFixed(1)} KB</div>` : ''}
                    ${doc.created_at ? `<div><strong>Created:</strong> ${new Date(doc.created_at).toLocaleDateString()}</div>` : ''}
                `;

                contentEl.textContent = doc.content || 'No content available';

            } catch (error) {
                metaEl.innerHTML = `<span style="color: var(--error);">Error loading document</span>`;
                contentEl.textContent = `Error: ${error.message}`;
            }
        }

        function closeDocumentPreview() {
            const modal = document.getElementById('documentPreviewModal');
            modal.classList.remove('active');
            currentPreviewDocument = null;
        }

        async function copyDocumentContent() {
            if (!currentPreviewDocument || !currentPreviewDocument.content) {
                alert('No content available to copy');
                return;
            }

            try {
                await navigator.clipboard.writeText(currentPreviewDocument.content);
                const copyBtn = document.getElementById('copyDocBtn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            } catch (error) {
                const textArea = document.createElement('textarea');
                textArea.value = currentPreviewDocument.content;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const copyBtn = document.getElementById('copyDocBtn');
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                    }, 2000);
                } catch (e) {
                    alert('Failed to copy to clipboard');
                }
                document.body.removeChild(textArea);
            }
        }

        function downloadDocument() {
            if (!currentPreviewDocument || !currentPreviewDocument.content) {
                alert('No content available to download');
                return;
            }

            const blob = new Blob([currentPreviewDocument.content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            let filename = currentPreviewDocument.title || 'document';
            filename = filename.replace(/\.[^/.]+$/, '') + '.txt';
            a.download = filename;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Close modal when clicking outside
        document.getElementById('documentPreviewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDocumentPreview();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDocumentPreview();
            }
        });
    </script>
</body>
</html>
