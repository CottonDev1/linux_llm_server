<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Management - RAG Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/layout.css">
    <link rel="stylesheet" href="../../css/ewr-classes.css">
    <script src="../../js/ewr-components.js"></script>
    <style>
        /* Dark Blue Theme - Always Dark (matching SQL chat) */
        :root {
            --bg-primary: #0c1929;
            --bg-secondary: #142338;
            --bg-tertiary: #1e3a5f;
            --bg-card: #142338;
            --bg-input: #142338;
            --text-primary: #e8f2ff;
            --text-secondary: #b8d4f0;
            --text-muted: #6b8cae;
            --border-primary: #1e3a5f;
            --border-secondary: #2d5a8a;
            --accent-primary: #5a9fe6;
            --accent-secondary: #7ab8f5;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --glow-accent: rgba(90, 159, 230, 0.3);
        }

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: var(--bg-primary);
            line-height: 1.6;
        }

        /* Single column layout */
        .documents-layout {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 150px);
            position: relative;
        }

        /* Message styles */
        .message {
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 8px;
        }

        .message.success {
            background: #064e3b;
            color: #6ee7b7;
            border: 1px solid #047857;
        }

        .message.error {
            background: #7f1d1d;
            color: #fca5a5;
            border: 1px solid #991b1b;
        }
    </style>
</head>
<body>
    <!-- Main Layout -->
    <div class="app-layout">
        <!-- Admin Sidebar Component -->
        <ewr-admin-sidebar></ewr-admin-sidebar>

        <!-- Main Content Area -->
        <div class="app-main">
            <!-- Admin Header Component -->
            <ewr-admin-header title="Document Management" show-refresh="false"></ewr-admin-header>

            <!-- Content -->
            <main class="app-content">
                <div class="content-wrapper">
                    <!-- Message Area -->
                    <div id="messageArea"></div>

                    <div class="documents-layout">
                        <!-- Full Width Card -->
                        <div class="card ewr_chat-card-full">
                            <!-- Collapsible Document Filters -->
                            <div class="ewr-collapsible no-margin" id="filterCollapsible">
                                <div class="ewr-collapsible-header" onclick="toggleCollapsible('filterCollapsible')">
                                    <span class="ewr-collapsible-title">Document Filters</span>
                                    <button class="ewr-collapse-toggle">
                                        <span class="toggle-icon">â–¼</span>
                                    </button>
                                </div>
                                <div class="ewr-collapsible-content">
                                    <div class="ewr-edit-filters-horizontal">
                                        <div class="ewr-edit-div-vert">
                                            <label class="ewr-label">Department</label>
                                            <select id="browserDepartmentFilter" class="ewr-select-edit">
                                                <option value="">All Departments</option>
                                            </select>
                                        </div>
                                        <div class="ewr-edit-div-vert">
                                            <label class="ewr-label">Doc Type</label>
                                            <select id="categoryFilter" class="ewr-select-edit">
                                                <option value="">All Types</option>
                                            </select>
                                        </div>
                                        <div class="ewr-edit-div-vert">
                                            <label class="ewr-label">Subject</label>
                                            <select id="browserSubjectFilter" class="ewr-select-edit">
                                                <option value="">All Subjects</option>
                                            </select>
                                        </div>
                                        <div class="ewr-edit-div-vert">
                                            <label class="ewr-label">Result Title Contains</label>
                                            <input type="text" id="searchFilter" class="ewr-input-edits" placeholder="Filter loaded results by title...">
                                        </div>
                                    </div>
                                </div>
                                <!-- Footer with Action Buttons -->
                                <div class="ewr-collapsible-footer">
                                    <button class="ewr-button-action-green-gradient" id="loadDocsBtn" onclick="loadDocuments()">Load Documents</button>
                                </div>
                            </div>

                            <!-- Document List Section -->
                            <ewr-document-list
                                id="documentList"
                                title="Matching Documents"
                                empty-message="Select filters and click &quot;Load Documents&quot; to see matching documents"
                                on-item-click="openDocumentPreview">
                            </ewr-document-list>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Document Preview Modal -->
    <div class="ewr-document-popup-overlay" id="documentPreviewModal">
        <div class="ewr-document-popup">
            <div class="ewr-document-popup-header">
                <h3 class="ewr-document-popup-title" id="documentPreviewTitle">Document Preview</h3>
                <button class="ewr-document-popup-close" onclick="closeDocumentPreview()">&times;</button>
            </div>
            <div class="ewr-document-popup-body">
                <div class="ewr-document-popup-meta" id="documentPreviewMeta">
                    <!-- Document metadata will be inserted here -->
                </div>
                <div class="ewr-document-popup-content" id="documentPreviewContent">
                    Loading document content...
                </div>
            </div>
            <div class="ewr-document-popup-footer">
                <div class="ewr-document-popup-footer-left">
                    <button class="ewr-button-action-green-gradient" id="copyDocBtn" onclick="copyDocumentContent()">Copy to Clipboard</button>
                    <button class="ewr-button-action-green-gradient" id="downloadDocBtn" onclick="downloadDocument()">Download</button>
                    <button class="ewr-button ewr-button-medium ewr-button-danger admin-only" id="deleteDocBtn" onclick="confirmDeleteDocument()">Delete Document</button>
                </div>
                <button class="ewr-button-clear" onclick="closeDocumentPreview()">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="ewr-delete-confirm-overlay" id="deleteConfirmModal">
        <div class="ewr-delete-confirm-dialog">
            <h3 class="ewr-delete-confirm-title">Confirm Delete</h3>
            <p class="ewr-delete-confirm-text" id="deleteConfirmText">Are you sure you want to delete this document? This action cannot be undone.</p>
            <div class="ewr-delete-confirm-buttons">
                <button class="ewr-button-clear" onclick="cancelDelete()">Cancel</button>
                <button class="ewr-button ewr-button-medium ewr-button-danger" onclick="executeDelete()" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <script src="../../js/auth-client.js"></script>
    <script src="../js/sidebar.js"></script>
    <script src="../../js/system-status.js"></script>
    <script>
        // Initialize auth client
        const auth = new AuthClient();

        // Check authentication
        if (!auth.isAuthenticated()) {
            window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
        } else {
            // Initialize sidebar and display user info
            initSidebar();
            displayUserInfo();
        }

        async function displayUserInfo() {
            try {
                const user = await auth.getUser();
                if (user) {
                    const userNameEl = document.getElementById('userName');
                    const userRoleEl = document.getElementById('userRole');

                    if (userNameEl) userNameEl.textContent = user.username;
                    if (userRoleEl) userRoleEl.textContent = user.role || 'User';

                    // Add admin class to body if user is admin
                    if (user.role === 'admin' || user.role === 'Admin') {
                        document.body.classList.add('user-is-admin');
                    }
                }
            } catch (error) {
                console.error('Failed to get user info:', error);
            }
        }

        function logout() {
            auth.logout();
        }

        // Toggle collapsible container
        function toggleCollapsible(id) {
            const container = document.getElementById(id);
            if (container) {
                container.classList.toggle('collapsed');
            }
        }

        // Show message
        function showMessage(message, type = 'success') {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;

            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        // ==================== CATEGORY MANAGEMENT ====================

        // Category data storage
        let categoryData = {
            departments: [],
            types: [],
            subjects: []
        };

        // Load categories from Python API (separate endpoints for each type)
        async function loadCategories() {
            try {
                const [departmentsRes, typesRes, subjectsRes] = await Promise.all([
                    fetch('/api/python/categories/departments', {
                        headers: { 'Authorization': `Bearer ${auth.getAccessToken()}` }
                    }),
                    fetch('/api/python/categories/types', {
                        headers: { 'Authorization': `Bearer ${auth.getAccessToken()}` }
                    }),
                    fetch('/api/python/categories/subjects', {
                        headers: { 'Authorization': `Bearer ${auth.getAccessToken()}` }
                    })
                ]);

                const [departmentsData, typesData, subjectsData] = await Promise.all([
                    departmentsRes.json(),
                    typesRes.json(),
                    subjectsRes.json()
                ]);

                // Extract categories from response
                if (departmentsData.success && departmentsData.categories) {
                    categoryData.departments = departmentsData.categories.sort((a, b) => (a.order || 0) - (b.order || 0));
                }
                if (typesData.success && typesData.categories) {
                    categoryData.types = typesData.categories.sort((a, b) => (a.order || 0) - (b.order || 0));
                }
                if (subjectsData.success && subjectsData.categories) {
                    categoryData.subjects = subjectsData.categories.sort((a, b) => (a.order || 0) - (b.order || 0));
                }

                populateDropdowns();
            } catch (error) {
                console.error('Error loading categories:', error);
                showMessage('Error loading categories: ' + error.message, 'error');
            }
        }

        // Populate all dropdowns with standard select elements
        function populateDropdowns() {
            const browserDept = document.getElementById('browserDepartmentFilter');
            const browserType = document.getElementById('categoryFilter');
            const browserSubject = document.getElementById('browserSubjectFilter');

            // Populate standard select elements
            if (browserDept) {
                browserDept.innerHTML = '<option value="">All Departments</option>' +
                    categoryData.departments.map(d => `<option value="${d.id || d.name}">${d.name || d.id}</option>`).join('');
            }
            if (browserType) {
                browserType.innerHTML = '<option value="">All Types</option>' +
                    categoryData.types.map(t => `<option value="${t.id || t.name}">${t.name || t.id}</option>`).join('');
            }
            if (browserSubject) {
                browserSubject.innerHTML = '<option value="">All Subjects</option>' +
                    categoryData.subjects.map(s => `<option value="${s.id || s.name}">${s.name || s.id}</option>`).join('');
            }
        }

        // Load categories on page load
        loadCategories();

        // ==================== DOCUMENT BROWSER FUNCTIONALITY ====================

        // Store all loaded documents for client-side filtering
        let allLoadedDocuments = [];
        let searchFilterTimeout = null;

        // Apply document name filter
        function applyNameFilter() {
            const searchTerm = document.getElementById('searchFilter')?.value?.trim().toLowerCase() || '';
            const documentListComponent = document.getElementById('documentList');

            if (allLoadedDocuments.length === 0) {
                return;
            }

            let filteredDocs;
            if (searchTerm) {
                // Support both string (title only) and object format
                filteredDocs = allLoadedDocuments.filter(doc => {
                    const title = typeof doc === 'string' ? doc : (doc.title || '');
                    return title.toLowerCase().includes(searchTerm);
                });
            } else {
                filteredDocs = [...allLoadedDocuments];
            }

            // Use component API to set documents (with category tags)
            if (filteredDocs.length > 0) {
                documentListComponent.setDocuments(filteredDocs);
            } else {
                documentListComponent.showEmpty('No documents match your search criteria');
            }
        }

        // Debounced version of applyNameFilter
        function applyNameFilterDebounced() {
            clearTimeout(searchFilterTimeout);
            searchFilterTimeout = setTimeout(applyNameFilter, 300);
        }

        // Load documents from MongoDB using aggregation
        async function loadDocuments() {
            const documentListComponent = document.getElementById('documentList');

            // Get filter values using component API
            const department = document.getElementById('browserDepartmentFilter')?.value || '';
            const docType = document.getElementById('categoryFilter')?.value || '';
            const subject = document.getElementById('browserSubjectFilter')?.value || '';

            // Show loading state using component API
            documentListComponent.showLoading();

            try {
                // Build query parameters
                const params = new URLSearchParams();
                if (department) params.append('department', department);
                if (docType) params.append('type', docType);
                if (subject) params.append('subject', subject);

                // Fetch filtered documents using aggregation via proxy
                const aggResponse = await fetch(`/api/python/documents/aggregate?${params.toString()}`);
                const aggData = await aggResponse.json();

                if (aggData.success) {
                    // Use documents array (with metadata) if available, fall back to titles
                    allLoadedDocuments = aggData.documents || aggData.titles || [];
                    applyNameFilter();
                } else {
                    allLoadedDocuments = [];
                    documentListComponent.showError(aggData.error || 'Failed to load documents');
                }
            } catch (error) {
                allLoadedDocuments = [];
                documentListComponent.showError(error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Set up search filter event listener
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchFilter');
            if (searchInput) {
                searchInput.addEventListener('input', applyNameFilterDebounced);
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        clearTimeout(searchFilterTimeout);
                        applyNameFilter();
                    }
                });
            }
        });

        // ==================== DOCUMENT PREVIEW FUNCTIONALITY ====================

        let currentPreviewDocument = null;

        async function openDocumentPreview(title) {
            const modal = document.getElementById('documentPreviewModal');
            const titleEl = document.getElementById('documentPreviewTitle');
            const metaEl = document.getElementById('documentPreviewMeta');
            const contentEl = document.getElementById('documentPreviewContent');

            currentPreviewDocument = null;

            // Show modal
            modal.classList.add('active');
            titleEl.textContent = title;
            metaEl.innerHTML = 'Loading metadata...';
            contentEl.textContent = 'Loading document content...';

            try {
                const response = await fetch(`/api/python/documents/by-title?title=${encodeURIComponent(title)}`);

                if (!response.ok) {
                    throw new Error(`Failed to fetch document: ${response.statusText}`);
                }

                const doc = await response.json();
                currentPreviewDocument = doc;

                metaEl.innerHTML = `
                    <div><strong>Department:</strong> ${doc.department || 'N/A'}</div>
                    <div><strong>Type:</strong> ${doc.type || 'N/A'}</div>
                    <div><strong>Subject:</strong> ${doc.subject || 'N/A'}</div>
                    <div><strong>Chunks:</strong> ${doc.total_chunks || 1}</div>
                    ${doc.file_size ? `<div><strong>Size:</strong> ${(doc.file_size / 1024).toFixed(1)} KB</div>` : ''}
                    ${doc.created_at ? `<div><strong>Created:</strong> ${new Date(doc.created_at).toLocaleDateString()}</div>` : ''}
                `;

                contentEl.textContent = doc.content || 'No content available';

            } catch (error) {
                metaEl.innerHTML = `<span style="color: var(--error);">Error loading document</span>`;
                contentEl.textContent = `Error: ${error.message}`;
            }
        }

        function closeDocumentPreview() {
            const modal = document.getElementById('documentPreviewModal');
            modal.classList.remove('active');
            currentPreviewDocument = null;
        }

        async function copyDocumentContent() {
            if (!currentPreviewDocument || !currentPreviewDocument.content) {
                alert('No content available to copy');
                return;
            }

            try {
                await navigator.clipboard.writeText(currentPreviewDocument.content);
                const copyBtn = document.getElementById('copyDocBtn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 2000);
            } catch (error) {
                const textArea = document.createElement('textarea');
                textArea.value = currentPreviewDocument.content;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const copyBtn = document.getElementById('copyDocBtn');
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                    }, 2000);
                } catch (e) {
                    alert('Failed to copy to clipboard');
                }
                document.body.removeChild(textArea);
            }
        }

        function downloadDocument() {
            if (!currentPreviewDocument || !currentPreviewDocument.content) {
                alert('No content available to download');
                return;
            }

            const blob = new Blob([currentPreviewDocument.content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            let filename = currentPreviewDocument.title || 'document';
            filename = filename.replace(/\.[^/.]+$/, '') + '.txt';
            a.download = filename;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ==================== DELETE FUNCTIONALITY ====================

        function confirmDeleteDocument() {
            if (!currentPreviewDocument) {
                alert('No document selected');
                return;
            }

            const confirmModal = document.getElementById('deleteConfirmModal');
            const confirmText = document.getElementById('deleteConfirmText');

            confirmText.innerHTML = `Are you sure you want to delete "<strong>${currentPreviewDocument.title}</strong>"?<br><br>This will permanently remove the document and all ${currentPreviewDocument.total_chunks || 1} chunk(s). This action cannot be undone.`;

            confirmModal.classList.add('active');
        }

        function cancelDelete() {
            const confirmModal = document.getElementById('deleteConfirmModal');
            confirmModal.classList.remove('active');
        }

        async function executeDelete() {
            if (!currentPreviewDocument) {
                alert('No document selected');
                return;
            }

            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Deleting...';

            const documentTitle = currentPreviewDocument.title;

            try {
                const response = await fetch(`/api/python/documents/by-title?title=${encodeURIComponent(documentTitle)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || 'Failed to delete document');
                }

                cancelDelete();
                closeDocumentPreview();

                showMessage(`Document "${documentTitle}" deleted successfully (${result.deleted_chunks} chunks removed)`, 'success');

                loadDocuments();

            } catch (error) {
                showMessage(`Error deleting document: ${error.message}`, 'error');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Delete';
            }
        }

        // Close modals when clicking outside
        document.getElementById('documentPreviewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDocumentPreview();
            }
        });

        document.getElementById('deleteConfirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelDelete();
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDocumentPreview();
                cancelDelete();
            }
        });
    </script>
    <script src="/js/sidebar-user.js"></script>
</body>
</html>
